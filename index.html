<!DOCTYPE html>
<html>

<head>
    <title>VS Schematic Inspector</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a1a;
            font-family: 'Segoe UI', sans-serif;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            color: white;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        /* New Inspector Panel */
        #inspector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            color: white;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            width: 250px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            border-left: 4px solid #0078d4;
        }

        #legend {
            margin-top: 15px;
            overflow-y: auto;
            border-top: 1px solid #444;
            padding-top: 10px;
            flex-grow: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 13px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.03);
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .legend-item.hidden-block {
            opacity: 0.2;
            filter: grayscale(1);
        }

        .color-box {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .block-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .block-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
            color: #ddd;
        }

        .block-count {
            font-family: monospace;
            background: #444;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #fff;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        button {
            flex: 1;
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        button:hover {
            background: #3a3a3a;
            border-color: #888;
        }

        input[type="file"] {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .trait {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
        }

        .trait b {
            color: #fff;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <div id="ui">
        <strong style="font-size: 1.2em; margin-bottom: 5px;">Schematic Analyzer</strong>
        <input type="file" id="fileInput" accept=".json,.hjson">
        <div class="button-group">
            <button onclick="toggleAll(true)">Show All</button>
            <button onclick="toggleAll(false)">Hide All</button>
        </div>
        <div id="legend"></div>
    </div>

    <div id="inspector">
        <strong style="color: #0078d4;">Block Traits</strong>
        <div id="traitContent"></div>
        <button style="margin-top: 15px;"
            onclick="document.getElementById('inspector').style.display='none'">Close</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const light = new THREE.PointLight(0xffffff, 0.5);
        camera.add(light);
        scene.add(camera);

        let blockGroup = new THREE.Group();
        scene.add(blockGroup);
        let blockMetadata = new Map();
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();

        let currentSchematicData = {"GameVersion":"1.21.6","SizeX":9,"SizeY":9,"SizeZ":1,"BlockCodes":{"3286":"game:metalblock-new-plain-gold","3267":"game:metalblock-new-plain-blackbronze"},"ItemCodes":{},"Indices":[3145728,4194304,5242880,1048577,2097153,3145729,4194305,5242881,6291457,7340033,1048578,2097154,3145730,4194306,5242882,6291458,7340034,3,1048579,2097155,3145731,4194307,5242883,6291459,7340035,8388611,4,1048580,2097156,3145732,4194308,5242884,6291460,7340036,8388612,5,1048581,2097157,3145733,4194309,5242885,6291461,7340037,8388613,1048582,2097158,3145734,4194310,5242886,6291462,7340038,1048583,2097159,3145735,4194311,5242887,6291463,7340039,3145736,4194312,5242888],"BlockIds":[3286,3286,3286,3286,3286,3286,3286,3286,3286,3286,3286,3267,3286,3286,3267,3286,3286,3286,3267,3286,3286,3286,3286,3286,3286,3286,3286,3267,3286,3286,3286,3286,3286,3286,3286,3286,3267,3286,3286,3286,3286,3286,3286,3286,3286,3267,3286,3286,3267,3286,3286,3286,3286,3286,3286,3286,3286,3286,3286,3286,3286],"DecorIndices":[],"DecorIds":[],"BlockEntities":{},"Entities":[],"ReplaceMode":2,"EntranceRotation":-1,"OriginalPos":{"X":513890,"Z":517371,"InternalY":126}};
        let selectedBlock = null; // Track the currently glowing block
        let originalColor = new THREE.Color();

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    render(data);
                } catch (e) { alert("Error reading file. Standard JSON required."); }
            };
            reader.readAsText(file);
        });

        window.addEventListener('click', (event) => {
            if (event.target.closest('#ui') || event.target.closest('#inspector')) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Filter out invisible blocks before checking for intersections
            const visibleBlocks = blockGroup.children.filter(obj => obj.visible);
            const intersects = raycaster.intersectObjects(visibleBlocks);

            // 1. Reset previous selection's glow
            if (selectedBlock) {
                selectedBlock.material.emissive.setHex(0x000000); // Turn off glow
                selectedBlock.material.emissiveIntensity = 0;
            }

            if (intersects.length > 0) {
                selectedBlock = intersects[0].object;

                // 2. Make it GLOW
                // We set the emissive color to a bright cyan/white
                selectedBlock.material.emissive.setHex(0x00ffff);
                selectedBlock.material.emissiveIntensity = 1.5; // High brightness

                showInspector(selectedBlock.userData);
            } else {
                document.getElementById('inspector').style.display = 'none';
            }
        });

        function showInspector(traits) {
            const panel = document.getElementById('inspector');
            const content = document.getElementById('traitContent');

           // Check the global data for the packedIndex
            const entityData = currentSchematicData.BlockEntities && 
                            currentSchematicData.BlockEntities[traits.packedIndex];


            panel.style.display = 'block';
            content.innerHTML = `
            <div class="trait"><b>Code:</b><br>${traits.blockCode}</div>
            <div class="trait"><b>Pos:</b> X:${traits.x}, Y:${traits.y}, Z:${traits.z}</div>
            <div class="trait"><b>Packed Index:</b> ${traits.packedIndex}</div>
            <div class="trait"><b>Block Entity:</b> ${entityData ? "✅ Yes" : "❌ No"}</div>
        `;
            console.log(traits);


            if (entityData) {
                console.log("Raw Encoded Entity Data:", entityData);
            }

        }

        function render(data) {
            blockGroup.clear();
            blockMetadata.clear();
            currentSchematicData = data;
            const geometry = new THREE.BoxGeometry(0.92, 0.92, 0.92);

            data.BlockIds.forEach((id) => {
                const code = data.BlockCodes[id] || "unknown";
                if (!blockMetadata.has(code)) {
                    blockMetadata.set(code, { color: stringToColor(code), visible: true, count: 0 });
                }
                blockMetadata.get(code).count++;
            });

            data.Indices.forEach((packedIndex, i) => {
                const x = packedIndex & 0x3FF;
                const z = (packedIndex >> 10) & 0x3FF;
                const y = (packedIndex >> 20) & 0x3FF;
                const code = data.BlockCodes[data.BlockIds[i]];

                const material = new THREE.MeshLambertMaterial({ color: blockMetadata.get(code).color });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.set(x - data.SizeX / 2, y, z - data.SizeZ / 2);

                // Store traits in userData
                cube.userData = { blockCode: code, x, y, z, packedIndex };

                blockGroup.add(cube);
            });

            updateLegendUI();
            camera.position.set(data.SizeX * 1.2, data.SizeY + 5, data.SizeZ * 1.2);
            controls.target.set(0, data.SizeY / 2, 0);
            controls.update();
        }

        render(currentSchematicData)

        window.toggleBlock = function (code) {
            const state = blockMetadata.get(code);
            state.visible = !state.visible;
            blockGroup.children.forEach(mesh => {
                if (mesh.userData.blockCode === code) mesh.visible = state.visible;
            });
            updateLegendUI();
        };

        window.toggleAll = function (visible) {
            blockMetadata.forEach((val) => val.visible = visible);
            blockGroup.children.forEach(mesh => mesh.visible = visible);
            updateLegendUI();
        };

        function updateLegendUI() {
            const container = document.getElementById('legend');
            container.innerHTML = '';
            const sortedEntries = [...blockMetadata.entries()].sort((a, b) => b[1].count - a[1].count);

            sortedEntries.forEach(([code, data]) => {
                const item = document.createElement('div');
                item.className = `legend-item ${data.visible ? '' : 'hidden-block'}`;
                item.onclick = () => toggleBlock(code);
                const cleanName = code.replace('game:', '').replace(/-/g, ' ');
                item.innerHTML = `
                <div class="color-box" style="background: ${data.color}"></div>
                <div class="block-info">
                    <div class="block-name" title="${code}">${cleanName}</div>
                    <div class="block-count">x${data.count}</div>
                </div>
            `;
                container.appendChild(item);
            });
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 60%, 55%)`;
        }

        function animate() {
            requestAnimationFrame(animate);

            // 3. Optional: Make the glow pulse for extra "magic"
            if (selectedBlock) {
                const pulse = (Math.sin(Date.now() * 0.005) + 1.5) * 0.5;
                selectedBlock.material.emissiveIntensity = pulse;
            }

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>

</html>